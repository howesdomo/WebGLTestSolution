<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        * {
            margin: 0px;
        }

        canvas {
            width: 100%;
            height: 100%
        }
    </style>

    <!-- 核心js -->
    <script src="script/angular.min.js"></script>
    <script src="script/three.js"></script>
    <script src="script/WebGL.js"></script>
    <!-- 鼠标控制Camera -->
    <script src="script/controls/OrbitControls.js"></script>
    <!-- 性能监控器 -->
    <script src="script/Stats.js"></script>

    <!-- 计算 -->
    <script src="script/calcShelf.js"></script>

    <script>

        var app = angular.module('myApp', []);

        app.controller('myController', ['$scope', '$rootScope', function ($scope, $rootScope) {
            $rootScope.step_0 = 'Root Step 0';
            $scope.step_1 = 'Root Step 1';
            $scope.step_2 = 'Root Step 2';
        }]);

        //
        var s_Controls_MinDistance = 10;
        var s_Controls_MaxDistance = 1500;

        var threeStart = function () {
            if (WEBGL.isWebGLAvailable() === false) {
                alert("浏览器支持WebGL:" + WEBGL.isWebGLAvailable());
                return;
            }

            initThree();
            initScene();
            initCamera();
            initControls();
            initLights();
            initFloor();
            initGrid();

            initObjects();

            animation();
        };

        var renderer; // 渲染器
        var stats; // 性能监控器
        var initThree = function () {
            // 定义渲染器
            width = window.innerWidth;
            height = window.innerHeight;

            renderer = new THREE.WebGLRenderer({
                antialias: true
            });

            if (width == 0 || height == 0) { // eslint-disable-line
                var msg = "Width :" + width + " Height :" + height;
                alert(msg);
                width = 800;
                height = 600;
            }

            renderer.setSize(width, height);
            document.body.appendChild(renderer.domElement);
            renderer.setClearColor(0xcccccc, 1.0);

            // 定义性能监视器Stats
            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.left = '0px';
            stats.domElement.style.top = '0px';

            document.body.appendChild(stats.domElement);

            // 注册事件
            window.addEventListener('resize', onWindowResize, false); // 窗口大小改变事件
        };

        var onWindowResize = function () { // 窗口大小改变事件
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        var scene;
        var initScene = function () {
            scene = new THREE.Scene();
        };

        var sceneAdd = function (obj) {
            scene.add(obj);
            objectArray.push(obj);
        };

        var camera;
        var initCamera = function () {
            //// camera PerspectiveCamera
            camera = new THREE.PerspectiveCamera(100, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(-100, 100, 0);
            camera.lookAt(150, 0, 150);

            // camera OrthographicCamera
            //camera = new THREE.OrthographicCamera(-200, 200, 105, -105, 1, 1000);

            //camera.position.x = 600;
            //camera.position.y = 600;
            //camera.position.z = 600;

            //camera.lookAt(new THREE.Vector3(130, 0, 130));
        };

        var controls;
        var initControls = function () {
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            //controls.addEventListener( 'change', render ); // call this only in static scenes (i.e., if there is no animation loop)

            controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;

            controls.minDistance = s_Controls_MinDistance;
            controls.maxDistance = s_Controls_MaxDistance;

            controls.maxPolarAngle = Math.PI;
        };

        var initLights = function () {
            var lightBase = new THREE.AmbientLight(0xffffff); // 环境光
            scene.add(lightBase);
            // 环境光是经过多次反射而来的光称为环境光，无法确定其最初的方向。环境光是一种无处不在的光。
            // 环境光源放出的光线被认为来自任何方向。因此，当你仅为场景指定环境光时，所有的物体无论法向量如何，都将表现为同样的明暗程度。 （这是因为，反射光可以从各个方向进入您的眼睛）
        };

        var initGrid = function () {
            var size = 10000;

            //// 生成辅助线
            //var helper = new THREE.GridHelper(
            //    size // size - 边长
            //    , 1000 // divisions - 边长分为多少小格
            //    // , 0x0000ff // color1 - 暂不使用, 已用 AxisHelper 标记 x,y,z的方向
            //    // , 0x808080 // color2 - 暂不使用, 已用 AxisHelper 标记 x,y,z的方向
            //);
            //scene.add(helper);

            var axesHelper = new THREE.AxesHelper(size); // X轴红色, Y轴绿色, Z轴蓝色
            scene.add(axesHelper);
        };

        var initFloor = function () {
            var dashSize = 1;
            var gapSize = 2;

            var geometry = new THREE.Geometry();
            geometry.vertices.push(new THREE.Vector3(-150, 0, 0));
            geometry.vertices.push(new THREE.Vector3(150, 0, 0));

            for (var i = 1; i <= 30; i++) {
                // 横线
                var lineX = new THREE.Line(geometry, new THREE.LineDashedMaterial({ color: 0xbfbfbf, opacity: 1, dashSize: dashSize, gapSize: gapSize }));
                lineX.position.x = 150;
                lineX.position.z = i * 10;
                lineX.position.y = 0;
                lineX.computeLineDistances();
                scene.add(lineX);

                // 竖线
                var lineZ = new THREE.Line(geometry, new THREE.LineDashedMaterial({ color: 0xbfbfbf, opacity: 1, dashSize: dashSize, gapSize: gapSize }));
                lineZ.position.x = i * 10;
                lineZ.position.y = 0;
                lineZ.position.z = 150;
                lineZ.rotation.y = 90 * Math.PI / 180;
                lineZ.computeLineDistances();
                scene.add(lineZ);
            }
        };

        var initObjects = function () {

        };

        var animation = function () {
            renderer.render(scene, camera);
            requestAnimationFrame(animation);
            // only required if controls.enableDamping = true, or if controls.autoRotate = true
            controls.update(); // 鼠标控制视觉(OrbitControls)更新
            stats.update(); // 性能监视器(Stats)更新
        };

        var objectArray = new Array();

        var btnSubmit_Click = function () {

            var shelf = new Object();
            shelf.id = document.getElementById("txtID").value;
            shelf.rowCount = parseInt(document.getElementById("txtRow").value);
            shelf.columnCount = parseInt(document.getElementById("txtColumn").value);
            shelf.floorCount = parseInt(document.getElementById("txtFloor").value);

            shelf.x = parseInt(document.getElementById("txtX").value); // 在哪个方格 x
            shelf.z = parseInt(document.getElementById("txtZ").value); // 在哪个方格 z

            initShelf(shelf);
        };

        var btnClearSubmit_Click = function () {
            for (var i = 0; i < objectArray.length; i++) {
                scene.remove(objectArray[i]);
            }

            objectArray = new Array();
            btnSubmit_Click();
        };

        var btnTemp_Click = function () {
            console.log(camera);

            console.log(camera.position.x);
            console.log(camera.position.y);
            console.log(camera.position.z);

            console.log(camera.up.x);
            console.log(camera.up.y);
            console.log(camera.up.z);

            console.log(document.getElementById("txtCamera_Position_X"));

            //document.getElementById("txtCamera_Position_X").value = camera.position.x;
            //document.getElementById("txtCamera_Position_Y").value = camera.position.y;
            //document.getElementById("txtCamera_Position_Z").value = camera.position.z;

            //document.getElementById("txtCamera_up_X").value = camera.up.x;
            //document.getElementById("txtCamera_up_Y").value = camera.up.y;
            //document.getElementById("txtCamera_up_Z").value = camera.up.z;
        };

    </script>
</head>
<body onload="threeStart();">
    <div style="position: absolute; width:200px; height:200px; left:5px; top: 60px; ">
        <table>
            <tbody>
                <tr><td>层</td><td><input id="txtFloor" type="tel" value="4" /></td></tr>
                <tr><td>格</td><td><input id="txtColumn" type="tel" value="5" /></td></tr>
                <tr><td>行</td><td><input id="txtRow" type="tel" value="2" /></td></tr>
                <tr><td>X</td><td><input id="txtX" type="tel" value="2" /></td></tr>
                <tr><td>Z</td><td><input id="txtZ" type="tel" value="3" /></td></tr>
                <tr><td>ID</td><td><input id="txtID" type="tel" value="S01" /></td></tr>
            </tbody>
        </table>
        <div>
            <input id="btnSubmit" type="button" value="添加" onclick="btnSubmit_Click()" />
            <input id="btnClearSubmit" type="button" value="清除后添加" onclick="btnClearSubmit_Click()" />
        </div>
    </div>
    <div style="position: absolute; width:200px; height:200px; left:5px; top: 260px; ">
        <h2>Camera</h2>
        <span>position</span>
        <table>
            <tbody>
                <tr><td>X</td><td><input id="txtCamera_position_X" type="text" value="{{camera.position.x}}" /></td></tr>
                <tr><td>Y</td><td><input id="txtCamera_position_Y" type="text" value="{{camera.position.y}}" /></td></tr>
                <tr><td>Z</td><td><input id="txtCamera_position_Z" type="text" value="{{camera.position.z}}" /></td></tr>
            </tbody>
        </table>
        <span>up</span>
        <table>
            <tbody>
                <tr><td>X</td><td><input id="txtCamera_up_X" type="text" value="{{camera.up.x}}" /></td></tr>
                <tr><td>Y</td><td><input id="txtCamera_up_Y" type="text" value="{{camera.up.y}}" /></td></tr>
                <tr><td>Z</td><td><input id="txtCamera_up_Z" type="text" value="{{camera.up.z}}" /></td></tr>
            </tbody>
        </table>

        <div>
            <input id="btnTemp" type="button" value="获取信息" onclick="btnTemp_Click()" />
        </div>
    </div>
</body>
</html>